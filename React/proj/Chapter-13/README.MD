# memo

`memo` å¯ä»¥è®©ä½ åœ¨ç»„å»ºçš„props ä¸å˜æ—¶è·³è¿‡é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚

```javascript
memo(Component, compare)
```

- ç”¨é€”
    - å½“props ä¸å˜æ—¶è·³è¿‡é‡æ–°æ¸²æŸ“
    - ä½¿ç”¨stateæ›´æ–°è®°å¿†ç»„ä»¶
    - ä½¿ç”¨ context æ›´æ–°è®°å¿†ç»„ä»¶
    - æœ€å°åŒ– props å˜åŒ–
    - å¯ä»¥å®šä¹‰æ¯”è¾ƒå‡½æ•°
- æ³¨æ„
  - å½“props æ˜¯å¼•ç”¨ç±»å‹æ—¶ï¼Œmemo ä¼šæ¯”è¾ƒå¼•ç”¨åœ°å€ï¼Œè€Œä¸æ˜¯å¼•ç”¨å€¼ã€‚

## ä½¿ç”¨
```javascript
memo(Component, compare)
```
ä½¿ç”¨memo åŒ…è£¹ä¸€ä¸ªç»„ä»¶ï¼Œä»è€Œå¾—åˆ°æ”¹ç»„ä»¶çš„ç¼“å­˜ç‰ˆæœ¬ã€‚å½“è¯¥ç¼“å­˜ç»„ä»¶çš„çˆ¶ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“æ—¶ï¼Œåªè¦propsæ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œ
è¯¥ç¼“å­˜ç»„ä»¶é€šå¸¸ä¸ä¼šè¢«æ¸²æŸ“ã€‚

## å‚æ•°
- Componentï¼šéœ€è¦è¢«ç¼“å­˜çš„ç»„ä»¶ã€‚
- compareï¼šæ¯”è¾ƒå‡½æ•°ï¼Œç”¨äºæ¯”è¾ƒæ–°æ—§propsæ˜¯å¦ç›¸ç­‰ã€‚é»˜è®¤æ˜¯æµ…æ¯”è¾ƒã€‚React ä¸­ä½¿ç”¨Object.is()è¿›è¡Œæ¯”è¾ƒã€‚

## ä½œç”¨
### è·³è¿‡é‡æ–°æ¸²æŸ“ï¼Œå½“props æ²¡æœ‰å‘ç”Ÿæ”¹å˜æ—¶ã€‚
å½“çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œå­ç»„ä»¶é€šå¸¸éƒ½ä¼šè¢«é‡æ–°æ¸²æŸ“ã€‚ä½¿ç”¨ `memo`, å¯ä»¥è®©å­ç»„ä»¶åœ¨props æ²¡æœ‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè·³è¿‡é‡æ–°æ¸²æŸ“ã€‚

å°†ä¸€ä¸ªç»„ä»¶ `memo` åŒ–ã€‚åªéœ€è¦ä½¿ç”¨ memo å°†å…¶åŒ…è£¹ï¼Œç„¶åç”¨å®ƒè¿”å›çš„å€¼ä»£æ›¿åŸæ¥çš„ç»„ä»¶ã€‚
```javascript
const Greeting = memo(function Greeting({ name }) {
  return <h1>Hello, {name}!</h1>;
});

export default Greeting;
```

åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ã€‚ä½¿ç”¨React.memo æ—¶ï¼šGreetings ç»„ä»¶åœ¨nameè¢«æ”¹å˜æ—¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œåœ¨address è¢«æ”¹å˜æ—¶ä¸ä¼šé‡ç°æ¸²æŸ“ã€‚
æœªä½¿ç”¨React.memo æ—¶ï¼šGreetings ç»„ä»¶åœ¨nameå’Œaddress è¢«æ”¹å˜æ—¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚
```javascript
function MyApp() {
    const [name, setName] = React.useState('');
    const [address, setAddress] = React.useState('');
    return (
      <>
        <label>
          Name{': '}
          <input value={name} onChange={e => setName(e.target.value)} />
        </label>
        <label>
          Address{': '}
          <input value={address} onChange={e => setAddress(e.target.value)} />
        </label>
        <Greeting name={name} />
      </>
    );
  }

  const Greeting = React.memo(function Greeting({ name }) {
    console.log("Greetingé‡å¤æ¸²æŸ“", new Date().toLocaleTimeString());
    return <h3>Hello{name && ', '}{name}!</h3>;
  });

  const root = ReactDOM.createRoot(document.getElementById("root"))
  root.render(
    <MyApp />
  )
```
## æœ€å°åŒ– props å˜åŒ–
ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨memo,åº”è¯¥å°½å¯èƒ½å‡å°‘props å˜åŒ–ã€‚ä¾‹å¦‚ï¼šå¦‚æœ propsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥ä½¿ç”¨useMemoæ¥é˜²æ­¢çˆ¶ç»„ä»¶æ¯æ¬¡é‡æ–°åˆ›å»ºè¯¥å¯¹è±¡ã€‚
```javascript
function Page() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  const person = useMemo(
    () => ({ name, age }),
    [name, age]
  );

  return <Profile person={person} />;
}

const Profile = memo(function Profile({ person }) {
  // ...
});
```
ä¸€ç§æ›´å¥½çš„æ–¹å¼å°±æ˜¯è®©ç»„ä»¶æ¥æ”¶æ›´åŠ ç²¾ç¡®çš„props,ä¾‹å¦‚æ¥æ”¶ä¸¤ä¸ªç§æœ‰å€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚
```javascript
function Page() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  return <Profile name={name} age={age} />;
}

const Profile = memo(function Profile({ name, age }) {
  // ...
});
```

## memoæºç åˆ†æ

æ€»ä½“æ‰§è¡Œé€»è¾‘ï¼š
- åˆå§‹æ¸²æŸ“ 
  - beginWorkã€‚ï¼ˆè¿™ä¸ªæ—¶å€™è¿˜æ˜¯ MemoComponentï¼‰
  - updateMemoComponentã€‚æ ‡è®° `workInProgress.tag = SimpleMemoComponent`;
  - updateSimpleMemoComponent
  - updateFunctionComponent
- æ‰§è¡Œæ›´æ–°
  - beginWorkã€‚ï¼ˆå·²ç»è¢«æ ‡è®°ä¸ºäº† SimpleMemoComponentï¼‰
  - updateSimpleMemoComponentã€‚æ‰§è¡Œæµ…æ¯”è¾ƒï¼ˆprops,refï¼Œtypeï¼‰,å¦‚æœéƒ½ç›¸ç­‰åªéœ€è¦æ‰§è¡Œèµ‹å€¼ã€‚ä¸è¿›å…¥
  - updateFunctionComponentï¼ˆæµ…æ¯”è¾ƒç»“æœä¸ºfalse,å°±ä¼šè¿›å…¥è¿™é‡Œï¼‰

###  updateFunctionComponent
- æ‰§è¡Œ renderWithHooksï¼Œæ‰§è¡Œå‡½æ•°ç»„ä»¶çš„é€»è¾‘ï¼Œä¼ å…¥äº†nextPropså’Œcontextï¼Œç”Ÿæˆchildï¼ˆReactElementï¼‰ã€‚
- æ‰§è¡Œ reconcileChildrenï¼Œç”ŸæˆchildFiberã€‚

```javascript

  function memo(type, compare) {
    {
      if (!isValidElementType(type)) {
        error('memo: The first argument must be a component. Instead ' + 'received: %s', type === null ? 'null' : typeof type);
      }
    }

    var elementType = {
      $$typeof: REACT_MEMO_TYPE,
      type: type,
      compare: compare === undefined ? null : compare
    };

    {
      var ownName;
      Object.defineProperty(elementType, 'displayName', {
        enumerable: false,
        configurable: true,
        get: function () {
          return ownName;
        },
        set: function (name) {
          ownName = name; // The inner component shouldn't inherit this display name in most cases,
          // because the component may be used elsewhere.
          // But it's nice for anonymous functions to inherit the name,
          // so that our component-stack generation logic will display their frames.
          // An anonymous function generally suggests a pattern like:
          //   React.memo((props) => {...});
          // This kind of inner function is not used elsewhere so the side effect is okay.

          if (!type.name && !type.displayName) {
            type.displayName = name;
          }
        }
      });
    }

    return elementType;
  }
```
åˆ›å»ºäº†ä¸€ä¸ª `REACT_MEMO_TYPE`ç±»å‹çš„å…ƒç´ ã€‚


- ä¸ºäº†æ‰¾å‡ºå¤„ç†é‡å¤æ¸²æŸ“çš„é€»è¾‘ï¼Œæ‰¾åˆ°å…³é”®çš„å…¥å£å¤„ `renderRootSync`ï¼Œ`workLoopSync`ï¼Œ`updateSimpleMemoComponent`ï¼Œ

- è¿›è¡Œæµ…æ¯”è¾ƒ.å› ä¸ºå¹¶æ²¡æœ‰é€’å½’çš„å¯¹æ¯ä¸€ä¸ªå±æ€§å€¼è¿›è¡Œæ¯”è¾ƒã€‚
```javascript

/**
 * æ‰§è¡Œæµ…æ¯”è¾ƒ
 * å¦‚æœå€¼ç›¸ç­‰è¿”å›true ï¼ˆè®¤ä¸ºç›¸ç­‰ï¼‰
 * objA ä¸æ˜¯ å¯¹è±¡æˆ–è€…æ˜¯nullï¼Œæˆ–è€…objB ä¸æ˜¯å¯¹è±¡æˆ–è€…æ˜¯nullï¼Œè¿”å›falseï¼ˆè®¤ä¸ºä¸ç›¸ç­‰ï¼‰
 * å¦‚æœobjA å’Œ objB çš„keyçš„æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿”å›falseï¼ˆè®¤ä¸ºä¸ç›¸ç­‰ï¼‰
 * éå†objA çš„keyï¼Œå¦‚æœobjB ä¸åŒ…å«è¯¥keyï¼Œæˆ–è€…objA å’Œ objB çš„keyå¯¹åº”çš„å€¼ä¸ç›¸ç­‰ï¼Œè¿”å›falseï¼ˆè®¤ä¸ºä¸ç›¸ç­‰ï¼‰
 * å…¶ä»–æƒ…å†µè¿”å›trueï¼ˆè®¤ä¸ºç›¸ç­‰ï¼‰
 * **/
  function shallowEqual(objA, objB) {
    if (objectIs(objA, objB)) {
      return true;
    }

    if (typeof objA !== 'object' || objA === null || typeof objB !== 'object' || objB === null) {
      return false;
    }

    var keysA = Object.keys(objA);
    var keysB = Object.keys(objB);

    if (keysA.length !== keysB.length) {
      return false;
    } // Test for A's keys different from B.


    for (var i = 0; i < keysA.length; i++) {
      var currentKey = keysA[i];

      if (!hasOwnProperty.call(objB, currentKey) || !objectIs(objA[currentKey], objB[currentKey])) {
        return false;
      }
    }

    return true;
  }


/**
 * æµ…æ¯”è¾ƒå­˜åœ¨çš„é—®é¢˜
 * ä»¥ä¸‹ aå’Œbå®é™…æ¥çœ‹ï¼Œæœ€ç»ˆçš„æ¸²æŸ“ç»“æœåº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯æµ…æ¯”è¾ƒä¼šè®¤ä¸ºä¸ç›¸ç­‰ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šé€ æˆé¡µé¢é‡æ–°åˆ·æ–°ã€‚
 * */
var a = {
  "name": {
    "v": "1"
  }
}
var b = {
  "name": {
    "v": "1"
  }
}
shallowEqual(a,b) // false
```

## æ€»ç»“
React.memo é€šè¿‡ åˆ›å»ºä¸€ä¸ª REACT_MEMO_TYPE ç±»å‹çš„å…ƒç´ ï¼Œ
- performUnitOfWork
- beginWork$1
- reconcileChildren
- createChild
- createFiberFromElement
- createFiberFromTypeAndProps


REACT_MEMO_TYPE å…ƒç´  é€šè¿‡ä¸Šè¿°æ­¥éª¤çš„è°ƒç”¨ï¼Œåˆ›å»ºäº† tagä¸º MemoComponent çš„fiber.  æ­¤åå³å¯æ‰§è¡Œ MemoComponentç›¸å…³çš„åˆå§‹é€»è¾‘å’Œæ›´æ–°é€»è¾‘ã€‚

åœ¨æ‰§è¡Œ updateFunctionComponent çš„é€»è¾‘ä¸­ï¼Œé€šè¿‡å¯¹å±æ€§ï¼ˆprops,ref,typeï¼‰çš„æµ…æ¯”è¾ƒ,ä»è€Œé¿å…äº†å‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œï¼Œé¿å…åˆ›å»ºæ–°çš„ReactElementå’Œfiber.
ä¹Ÿå°±é¿å…äº†é‡æ–°ç”ŸæˆDOMï¼Œæ›´æ–°DOMçš„è¿‡ç¨‹ã€‚

çº¯æ¸²æŸ“ç»„ä»¶ï¼Œå»ºè®®ä½¿ç”¨React.memoåŒ…è£¹ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚


## é—ç•™é—®é¢˜
- ğŸ’¬ performUnitOfWork ä¸­çš„ workInProgress åœ¨ä¸€å¼€å§‹æ˜¯å¦‚ä½•åˆ›å»ºçš„å‘¢ï¼Ÿ
    - workLoop ä¸­ã€‚ä» taskQueue ä¸­è·å– task.
    - task ä¸­çš„å›è°ƒè¿›å…¥ performConcurrentWorkOnRoot
    - è¿›å…¥ prepareFreshStack
    - createWorkInProgressã€‚ä¼ å…¥ğŸ’¬root.current,åˆ›å»ºå®Œæˆæœ€åˆçš„fiber
    - è¿›å…¥ workLoopSyncï¼Œè¿›å…¥ performUnitOfWork

- å…³äºroot
  - root.current æœ€å¼€å§‹æ˜¯ä¸€ä¸ª uninitializedFiberï¼ŒuninitializedFiber.stateNodeæŒ‡å‘äº†root.
  - è°ƒç”¨rootçš„renderæ–¹æ³•ï¼Œä¼ å…¥è¦æ¸²æŸ“çš„ReactElement:MyAppã€‚
  - MyApp æ”¾åœ¨ update.payload.element ä¸­ã€‚
  - å¤„ç† uninitializedFiber å’Œ updateã€‚
  - å¤„ç† uninitializedFiber.updateQueue.shared.interleaved èµ‹å€¼äº† update
  - æœ€ç»ˆroot.currentå°±å’ŒMyApp è¿›è¡Œäº†å…³è”
  - scheduleCallback$1è°ƒç”¨ã€‚åˆ›å»º performConcurrentWorkOnRootä¼ å…¥äº†rootçš„å›è°ƒå‡½æ•°ã€‚
  - åˆ›å»ºä¸€ä¸ªåŒ…å«è¯¥å›è°ƒå‡½æ•°çš„task,æ”¾å…¥taskQueueä¸­ã€‚
  - é€šè¿‡postMessageè°ƒç”¨ performWorkUntilDeadline
  - è¿›å…¥ workLoop,è·å–ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ä»»åŠ¡çš„å›è°ƒï¼ˆperformConcurrentWorkOnRootï¼‰ã€‚
  - è¿›å…¥ renderRootSyncï¼Œè¿›å…¥ prepareFreshStackã€‚
  - è¿›å…¥ workLoopSync
  - updateHostRoot
  - element è¿›å…¥äº† newBaseStateï¼Œå¹¶èµ‹å€¼ç»™äº† queue.baseState.(workInProgress.updateQueue.baseState)
  - å¼€å§‹reconcileChildren(ä¼ å…¥äº† workInProgress,ReactElement)
  - åˆ›å»ºMyAppçš„fiber
  - è°ƒç”¨ renderWithHooksï¼Œç»§ç»­ç”ŸæˆReactElement.
  - å†æ¬¡è¿›å…¥ reconcileChildrenï¼Œç”ŸæˆchildFiber
  - ä»¥æ­¤å¾ªç¯çš„ç”Ÿæˆ fiber é“¾è¡¨
  - [x] ğŸ’¬fiber é“¾è¡¨ç”Ÿæˆåï¼ŒDom çš„ç”Ÿæˆæ—¶æœºåœ¨ä»€ä¹ˆæ—¶å€™
    - å…³é”®å…¥å£å¤„ `reconcileChildren`
    - ä»çˆ¶åˆ°å­åˆ›å»ºfiberï¼ŒbeginWorkæ˜¯ç”Ÿæˆfiber é“¾è¡¨
    - è¿›å…¥ completeUnitOfWork,ä»å­åˆ°çˆ¶ç”ŸæˆDOMã€‚å¹¶appendChildåˆ°çˆ¶èŠ‚ç‚¹ä¸Šã€‚
  - [x] ğŸ’¬fiber é“¾è¡¨ç”Ÿæˆåï¼ŒDom ç”Ÿæˆå¹¶ä¸”çˆ¶å­å…³ç³»çš„æ—¶æœºåœ¨ä»€ä¹ˆæ—¶å€™
  - commitRootï¼Œè·å– finishedWork
  - commitBeforeMutationEffects ï¼Œä¼ å…¥ finishedWork
  - commitMutationEffectsï¼Œä¼ å…¥ finishedWork
  - commitMutationEffectsOnFiberï¼ˆå°†fiber ä¸Šçš„DOMæ¸²æŸ“åˆ€é¡µé¢ä¸Šï¼‰
- [x] ğŸ’¬Reactä¸­çš„ReactElementã€fiberã€Domä¹‹é—´çš„å…³ç³»ï¼Ÿ
  - é€šè¿‡é€ä¸ªè°ƒç”¨ReactElementç”ŸæˆFiberé“¾è¡¨ï¼Œé€šè¿‡æ·±åº¦fiberé“¾è¡¨ç”Ÿæˆå®Œæˆä¹‹åå†ç”ŸæˆDom æ ‘ï¼ˆæ·±åº¦ä¼˜å…ˆéå†çš„æ–¹å¼ï¼‰ã€‚
